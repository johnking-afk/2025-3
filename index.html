<html lang="en">

<head>
    <script>
        // Needed if webcam is used
    if (location.protocol == "http:") {
        location.protocol = "https:";
    }
    </script>
    <meta charset="UTF-8">
    <title>FaceCam</title>
    <script src="js/face-api.js"></script>
    <style>
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
        }
    </style>
</head>

<body>
    <label>Upload Image:</label> <input type="file" id="imgUploadInput" onchange="uploadImage(event)" accept=".jpg, .jpeg, .png">
    <label>Webcam:</label><input id="webCamToggle" type="checkbox">
    <label>Threshold:</label><input id="threshold" type="number" value=".30" step="0.01" min=".01" max="1.00">
    <label>maxDiff:</label><input id="maxDiff" type="number" value=".60" step="0.01" min=".01" max="1.00">
    Status: <span id="status"></span>
    <div id="imagediv">
        <img id="myImg" src= alt="" style="max-width: 800px;">
        <video id="webCam"></video>
    </div>
    <ol id="attendance">
        <li>Empty</li>
    </ol>
    <script>
    let peopleInPicture = [];
    var labeledFaceDescriptors = [];
    var faceMatcher = null;
    var threshold = .3;
    var maxDiff = .6;
    var srcId = "myImg";
    var webCamTimeout = 0;

    //localStorage.removeItem('faceMatcher'); //Uncomment to clear faceMatcher on load
    if (localStorage.getItem('faceMatcher')) {
        faceMatcher = faceapi.FaceMatcher.fromJSON(JSON.parse(localStorage.getItem('faceMatcher')));
        labeledFaceDescriptors = faceMatcher.labeledDescriptors;
        maxDiff = faceMatcher.distanceThreshold;
        document.getElementById('maxDiff').value = maxDiff;
    }

    function clearFaceNames() {
        let paras = document.getElementsByClassName('faceNames');
        while (paras[0]) {
            paras[0].parentNode.removeChild(paras[0]);
        }
    }

    function drawFaceRecognitionResults(results) {
        clearFaceNames()
        inputImgEl = document.getElementById(srcId);
        results = faceapi.resizeResults(results, inputImgEl);

        results.forEach(function(result) {
            let btn = document.createElement("button");
            if (result.bestMatch.label != 'unknown') {
                btn.innerText = result.bestMatch.label;
            } else {
                btn.innerText = result.age.toFixed(0) + ' year old ' + result.expressions.asSortedArray()[0].expression + ' ' + result.gender;
            }
            btn.title = (100 * (1 - result.bestMatch.distance)).toFixed(0) + ' %';
            btn.style.position = 'absolute';
            btn.style.top = result.detection.box.top + 'px';
            btn.style.left = result.detection.box.left + 'px';
            btn.className = 'faceNames';
            btn.dataset.person = result.bestMatch.label;
            btn.dataset.descriptor = result.descriptor;
            btn.addEventListener("click", personClick);
            document.getElementById("imagediv").appendChild(btn);
        })
    }

    function makeFaceMatcher() {
        if (labeledFaceDescriptors.length > 0) {
            faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, maxDiff);
            localStorage.setItem('faceMatcher', JSON.stringify(faceMatcher.toJSON()));
        }
    }

    function addDescriptor(newPerson, descriptor) {
        for (let i = 0; i < labeledFaceDescriptors.length; i++) {
            if (labeledFaceDescriptors[i].label == newPerson) {
                labeledFaceDescriptors[i].descriptors.push(new Float32Array(descriptor.split(',')));
                makeFaceMatcher();
                return;
            }
        }
        descriptors = [];
        descriptors.push(new Float32Array(descriptor.split(',')));
        labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(newPerson, descriptors));
        makeFaceMatcher();
    }

    function personClick(e) {
        var newPerson = prompt("Please enter person's name:", e.target.dataset.person);
        if (newPerson == null || newPerson == "" || newPerson == "unknown") {} else {
            e.target.dataset.person = newPerson;
            e.target.innerHTML = newPerson;
            addDescriptor(newPerson, e.target.dataset.descriptor);
            if (!document.getElementById('webCamToggle').checked) {
                updateResults();
            }
        }
    }
    async function loadModels() {
        console.time('loadModels')
        updateStatus('loadModels');
        //let weightsURI = "weights";
        let weightsURI = "https://seattleacademy.github.io/faceRoster/weights";
        updateStatus('ssdMobilenetv1');
        await faceapi.nets.ssdMobilenetv1.load(weightsURI);
        updateStatus('faceLandmark68Net');
        await faceapi.nets.faceLandmark68Net.load(weightsURI);
        updateStatus('faceExpressionNet');
        await faceapi.nets.faceExpressionNet.load(weightsURI);
        updateStatus('ageGenderNet');
        await faceapi.nets.ageGenderNet.load(weightsURI);
        updateStatus('faceRecognitionNet');
        await faceapi.nets.faceRecognitionNet.loadFromUri(weightsURI)
        console.timeEnd('loadModels')
    }

    async function updateResults() {
        console.time('updateResults')
        updateStatus('upateResults');
        let options = new faceapi.SsdMobilenetv1Options({ minConfidence: Number(threshold) })
        results = await faceapi.detectAllFaces(srcId, options).withFaceLandmarks().withFaceExpressions().withAgeAndGender().withFaceDescriptors();

        results.forEach(function(result, i, results) {
            if (faceMatcher) {
                results[i].bestMatch = faceMatcher.findBestMatch(result.descriptor)
            } else {
                results[i].bestMatch = new faceapi.FaceMatch('unknown', 1);
            }
        })

        drawFaceRecognitionResults(results);
        updateAttendance(results);
        updateStatus('');
        console.timeEnd('updateResults')
        if (document.getElementById('webCamToggle').checked) {
            webCamTimeout = setTimeout(updateResults, 200);
        }
    }

    async function uploadImage(e) {
        const imgFile = e.target.files[0]
        const img = await faceapi.bufferToImage(imgFile)
        document.getElementById("myImg").src = img.src
        updateResults();
    }

    function toggleWebCam(enable) {
        clearFaceNames()
        webCam = document.getElementById('webCam');
        let constraints = true;

        if (enable) {
            navigator.mediaDevices.getUserMedia({ video: constraints }).then(function(stream) {
                document.getElementById("webCam").width = stream.getTracks()[0].getSettings().width;
                document.getElementById("webCam").height = stream.getTracks()[0].getSettings().height;
                srcId = "webCam"
                document.getElementById("imgUploadInput").value = "";
                document.getElementById("myImg").style.display = "none";
                document.getElementById("webCam").style.display = "block";
                webCam.srcObject = stream;
                webCam.play().then(updateResults);
            });
        } else {
            if (webCam.srcObject) {
                webCam.srcObject.getTracks().forEach(function(track) {
                    track.stop();
                });
            }
            webCam.src = "";
            srcId = "myImg";
            document.getElementById("webCam").style.display = "none";
            document.getElementById("myImg").style.display = "block";
            clearTimeout(webCamTimeout);
            updateResults();
        }
        document.getElementById('webCamToggle').checked = enable;
    }

    function updateStatus(str) {
        document.getElementById("status").innerHTML = str;
    }

    document.getElementById('threshold').addEventListener('change', function(event) {
        threshold = event.target.value;
        makeFaceMatcher();
        updateResults();
    }, false);

    document.getElementById('maxDiff').addEventListener('change', function(event) {
        maxDiff = event.target.value;
        makeFaceMatcher();
        updateResults();
    }, false);

    document.getElementById('webCamToggle').addEventListener('change', function(event) {
        toggleWebCam(event.target.checked);
    }, false);

    loadModels().then(updateResults);

    function updateAttendance(results) {
        for (let i = 0; i < results.length; i++) {
            let isUnique = true;
            for (let j = 0; j < peopleInPicture.length; j++) {
                if (results[i].bestMatch.label == peopleInPicture[j]) {
                    isUnique = false;
                }
            }
            if (isUnique) {
                let person = results[i].bestMatch.label;
                fetch("https://math.seattleacademy.org/1527?name=" + person)
                peopleInPicture.push(results[i].bestMatch.label)
            }
            // console.log(peopleInPicture);
        }
        let peoplestr = ""
        for(let k = 0; k < peopleInPicture.length; k++){
            // console.log(peopleInPicture[k])
            peoplestr += '<li>' + peopleInPicture[k] + '</li>'
            // console.log(peoplestr)
        }
        document.getElementById('attendance').innerHTML = peoplestr;
    }


<form class="summoner-search-form" action="/summoner/" autocomplete="off">
            <input type="text" name="userName" class="summoner-search-form__text" placeholder="Name1, Name2, ...">
            <button type="submit" class="summoner-search-form__button">
                <i class="__spSite __spSite-42"></i>
            </button>
            <button type="button" class="summoner-search-form__setting" onclick="$.OP.GG.layout.regionLanguage.open();">
                <span>NA</span>
                <i class="__spSite __spSite-138"></i>
            </button>
            <div class="summoner-search-extra">
                <div class="summoner-search-history">
                    <div class="tabWrap _recognized">
                        <ul class="summoner-search-history__title tabHeaders">
                            <li class="tabHeader active" data-tab-show-class="summoner-search-history--recent">
                                <a href="javascript:;">Recent Search</a>
                            </li>
                            <li class="tabHeader" data-tab-show-class="summoner-search-history--favorite">
                                <a href="javascript:;">Favorites</a>
                            </li>
                        </ul>
                        <div class="tabItems">
                            <div class="tabItem summoner-search-history--recent" style="display: block;">
                                <div class="RecentSummonerListWrap">
                                    <div class="summoner-search-history__list RecentSummonerList"><div class="Item favorited">  <a href="/summoner/userName=ErrorEmerald" class="Link">ErrorEmerald</a> <div class="Actions"><a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.toggle('ErrorEmerald');" class="Action Add"></a><a href="#" onclick="$.OP.GG.common.SummonerHistory.History.remove('ErrorEmerald');" class="Action Delete"></a>   </div></div><div class="Item "> <a href="/summoner/userName=GeeDub" class="Link">GeeDub</a> <div class="Actions"><a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.toggle('GeeDub');" class="Action Add"></a><a href="#" onclick="$.OP.GG.common.SummonerHistory.History.remove('GeeDub');" class="Action Delete"></a>   </div></div><div class="Item "> <a href="/summoner/userName=AlphaChadJungle" class="Link">AlphaChadJungle</a>   <div class="Actions"><a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.toggle('AlphaChadJungle');" class="Action Add"></a><a href="#" onclick="$.OP.GG.common.SummonerHistory.History.remove('AlphaChadJungle');" class="Action Delete"></a> </div></div><div class="Item "> <a href="/summoner/userName=gus2slow" class="Link">gus2slow</a> <div class="Actions"><a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.toggle('gus2slow');" class="Action Add"></a><a href="#" onclick="$.OP.GG.common.SummonerHistory.History.remove('gus2slow');" class="Action Delete"></a>   </div></div><div class="Item "> <a href="/summoner/userName=VanilaDaKila" class="Link">VanilaDaKila</a> <div class="Actions"><a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.toggle('VanilaDaKila');" class="Action Add"></a><a href="#" onclick="$.OP.GG.common.SummonerHistory.History.remove('VanilaDaKila');" class="Action Delete"></a>   </div></div><div class="Item "> <a href="/summoner/userName=chillfio" class="Link">chillfio</a> <div class="Actions"><a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.toggle('chillfio');" class="Action Add"></a><a href="#" onclick="$.OP.GG.common.SummonerHistory.History.remove('chillfio');" class="Action Delete"></a>   </div></div><div class="Item "> <a href="/summoner/userName=kittykatisme" class="Link">kittykatisme</a> <div class="Actions"><a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.toggle('kittykatisme');" class="Action Add"></a><a href="#" onclick="$.OP.GG.common.SummonerHistory.History.remove('kittykatisme');" class="Action Delete"></a>   </div></div><div class="Item favorited">    <a href="/summoner/userName=TheMoosely1" class="Link">TheMoosely1</a>   <div class="Actions"><a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.toggle('TheMoosely1');" class="Action Add"></a><a href="#" onclick="$.OP.GG.common.SummonerHistory.History.remove('TheMoosely1');" class="Action Delete"></a> </div></div><div class="Item "> <a href="/summoner/userName=The%20TH0T%20PATR0L" class="Link">The TH0T PATR0L</a>   <div class="Actions"><a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.toggle('The TH0T PATR0L');" class="Action Add"></a><a href="#" onclick="$.OP.GG.common.SummonerHistory.History.remove('The TH0T PATR0L');" class="Action Delete"></a> </div></div></div>
                                    <div class="summoner-search-history__message NotFound" style="display: none;">
                                        <span><img src="//opgg-static.akamaized.net/images/site/icon-history-info.png" class="Image">There is no summoner you have seen recently.</span>
                                    </div>
                                </div>
                            </div>
                            <div class="tabItem summoner-search-history--favorite" style="display: none;">
                                <div class="FavoriteSummonerListWrap">
                                    <div class="summoner-search-history__list FavoriteSummonerList"><div class="Item">  <a href="/summoner/userName=ErrorEmerald" class="Link">     <div class="SummonerName">ErrorEmerald</div>    </a>    <div class="Actions">       <a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.remove('ErrorEmerald'); return false;" class="Action Delete">해제</a>    </div></div><div class="Item">  <a href="/summoner/userName=Kat323" class="Link">       <div class="SummonerName">Kat323</div>  </a>    <div class="Actions">       <a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.remove('Kat323'); return false;" class="Action Delete">해제</a>  </div></div><div class="Item">  <a href="/summoner/userName=Smoldered%20Dreams" class="Link">       <div class="SummonerName">Smoldered Dreams</div>    </a>    <div class="Actions">       <a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.remove('Smoldered Dreams'); return false;" class="Action Delete">해제</a>    </div></div><div class="Item">  <a href="/summoner/userName=SoullessVortex" class="Link">       <div class="SummonerName">SoullessVortex</div>  </a>    <div class="Actions">       <a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.remove('SoullessVortex'); return false;" class="Action Delete">해제</a>  </div></div><div class="Item">  <a href="/summoner/userName=TheMoosely1" class="Link">      <div class="SummonerName">TheMoosely1</div> </a>    <div class="Actions">       <a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.remove('TheMoosely1'); return false;" class="Action Delete">해제</a> </div></div><div class="Item">  <a href="/summoner/userName=Wickzer" class="Link">      <div class="SummonerName">Wickzer</div> </a>    <div class="Actions">       <a href="#" onclick="$.OP.GG.common.SummonerHistory.Favorite.remove('Wickzer'); return false;" class="Action Delete">해제</a> </div></div></div>
                                    <div class="summoner-search-history__message NotFound" style="display: none;">
                                        <span><img src="//opgg-static.akamaized.net/images/site/icon-history-info.png" class="Image">Add your <i class="__spSite __spSite-100"></i> favorite summoner for easy updates on the latest stats.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                            </div>
        </form>
    </script>
</body>

</html>
